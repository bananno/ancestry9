<%
  const rootPath = '/source/' + source._id;
  const rootEditPath = '/source/' + source._id + '/edit';

  let canDeleteSource = source.people.length == 0
    && (source.links || []).length == 0
    && (source.images || []).length == 0
    && (source.tags || []).length == 0
    && (source.citations || []).length == 0
    && (source.notes || '').length == 0
    && (source.summary || '').length == 0
    && (source.content || '').length == 0;

  const canHaveDate = !['cemetery'].includes(source.story.type)
    || (source.date && (source.date.year || source.date.month
      || source.date.day || source.date.display));

  const canHaveLocation = !['cemetery', 'newspaper'].includes(source.story.type)
    || (source.location && (source.location.country || source.location.region1
      || source.location.region2 || source.location.city
      || source.location.notes));
%>

<% if (canDeleteSource) { %>
  <form action="/source/<%= source._id %>/delete" method="POST"
      onsubmit="return confirmDeletion('source')" style="margin: 20px;">
    <button>delete source</button>
  </form>
<% } %>

<table class="edit-form-frame">

  <!-- SHARING -->

  <%- include('../forms/tableRowSingle', {
    attr: 'sharing',
    editPath: rootEditPath + '/sharing',
    originalValue: source.sharing,
    toggle: true,
    preventSharing: source.story && !source.story.sharing,
  }) %>

  <!-- STORY -->

  <%- include('../forms/tableRowSingle', {
    attr: 'story',
    editPath: rootEditPath + '/story',
    originalValue: source.story,
  }) %>

  <!-- TITLE -->

  <%- include('../forms/tableRowSingle', {
    attr: 'title',
    editPath: rootEditPath + '/title',
    originalValue: source.title,
  }) %>

  <!-- DATE -->

  <% if (canHaveDate) { %>
    <%- include('../forms/tableRowSingle', {
      attr: 'date',
      editPath: rootEditPath + '/date',
      originalValue: source.date,
    }) %>
  <% } %>

  <!-- LOCATION -->

  <% if (canHaveLocation) { %>
    <%- include('../forms/tableRowSingle', {
      attr: 'location',
      editPath: rootEditPath + '/location',
      originalValue: source.location,
    }) %>
  <% } %>

  <!-- PEOPLE -->

  <%- include('../forms/tableRowMulti', {
    attr: 'people',
    rootPath: rootPath,
    values: source.people,
  }) %>

  <!-- LINKS -->

  <%- include('../forms/tableRowMulti', {
    attr: 'links',
    rootPath: rootPath,
    values: source.links,
  }) %>

  <!-- IMAGES -->

  <%- include('../forms/tableRowMulti', {
    attr: 'images',
    rootPath: rootPath,
    values: source.images,
  }) %>

  <!-- IMAGES -->

  <%- include('../forms/tableRowMulti', {
    attr: 'tags',
    rootPath: rootPath,
    values: source.tags,
  }) %>

  <!-- NOTES -->

  <%- include('../forms/tableRowSingle', {
    attr: 'notes',
    editPath: rootEditPath + '/notes',
    originalValue: source.notes,
    fieldType: 'textarea',
  }) %>

  <!-- SUMMARY -->

  <%- include('../forms/tableRowSingle', {
    attr: 'summary',
    editPath: rootEditPath + '/summary',
    originalValue: source.summary,
    fieldType: 'textarea',
  }) %>

  <!-- STORIES -->

  <%- include('../forms/tableRowMulti', {
    attr: 'stories',
    rootPath: rootPath,
    values: source.stories,
  }) %>
</table>

<div>
  <h2>Content</h2>

  <p>
    <span class="clickable-link main-link link-start"
      onClick="startEdit('content')">edit</span>
  </p>

  <div class="value-show" item="content">
    <%- include('../format/content', {
      content: source.content,
      limit: false,
    }) %>
  </div>

  <div class="value-edit" item="content">
    <form action="<%= rootEditPath %>/content" method="POST">
      <textarea name="content" class="content-textarea"><%= source.content %></textarea>
      <input type="hidden" value="PUT" name="_method">
      <button type="submit">save</button>
      <span class="clickable-link link-cancel"
        onClick="cancelEdit()" item="content">cancel</span>
    </form>
  </div>
</div>

<h2>Citations</h2>

<%- include('./citationForm', {
  rootPath: rootPath,
  rootEditPath: rootEditPath,
}) %>

<%- include('../partials/citationList', {
  citations: citations,
  showDelete: true,
  showSource: false,
  showPerson: true,
  rootPath: rootPath,
  groupBy: 'person',
}) %>

<script>
  initializeEditForm();
</script>
