<%
  const dataType = locals.dataType || attr;
  const addItemPath = rootPath + '/add/' + attr;

  let peopleDropdownList = [];

  if (dataType == 'people') {
    const peopleIds = values.map(person => '' + person._id);
    if (locals.unlinkedPeople) {
      peopleDropdownList = unlinkedPeople;
    } else {
      peopleDropdownList = people.filter(person => {
        return !peopleIds.includes('' + person._id);
      });
    }
  }
%>

<% values.forEach((thisItem, index) => { %>
  <%
    const itemId = thisItem._id || index;
    const deleteItemPath = rootPath + '/delete/' + attr + '/' + itemId;
    const reorderItemPath = rootPath + '/reorder/' + attr + '/' + itemId;
    const updateItemPath = rootPath + '/update/' + attr;

    let canEditTag;

    const i = index;//get rid of
  %>

  <tr>
    <td>
      <% if (i == 0) { %>
        <b><%= attr %></b>
      <% } %>
    </td>

    <!-- DISPLAY VALUE -->

    <td
      <%= attr === 'tags' ? '' : 'colspan=2' %>
    >
      <% if (dataType == 'links') { %>
        <%- include('../format/externalLink', {url: thisItem}) %>
      <% } else if (dataType == 'images') { %>
        <%- include('../image/_link', {image: thisItem}) %>
      <% } else if (dataType == 'people') { %>
        <%- include('../person/_link', {person: thisItem}) %>
      <% } else if (dataType == 'stories') { %>
        <%- include('../story/_link', {story: thisItem}) %>
      <% } else if (dataType == 'tags') { %>
        <%- include('../tag/_link', {tag: thisItem}) %>
        <% if (item.tagValues[i]) { %>
        <% } %>
      <% } else { %>
        <%= thisItem %>
      <% } %>
    </td>

    <!-- EDITABLE VALUE -->

    <% if (attr === 'tags') { %>
      <td>
        <%
          const tagValue = item.tagValues[i];

          let showDropdown, showTextbox, valueList = [];

          if (thisItem.valueType === 2) {
            valueList = thisItem.values
              ? thisItem.values.split('\n').map(s => s.trim())
              : [];
            if (!tagValue || valueList.includes(tagValue)) {
              showDropdown = true;
            } else {
              showTextbox = true;
            }
            canEditTag = true;
          } else if (tagValue || thisItem.valueType === 1) {
            showTextbox = true;
            canEditTag = true;
          }
        %>

        <span item="<%= attr + '-' + i %>" class="value-show"><%= tagValue %></span>

        <form
          action="<%= updateItemPath %>"
          method="post"
          item="<%= attr + '-' + index %>"
          class="value-edit"
        >
          <input type="hidden" name="index" value="<%= index %>">
          <div>
            <% if (showDropdown) { %>
              <select name="newValue">
                <% valueList.forEach(value => { %>
                  <%
                    let selected = value === tagValue ? 'selected' : '';
                  %>
                  <option <%= selected %>>
                    <%= value %>
                  </option>
                <% }); %>
              </select>
            <% } else if (showTextbox) { %>
              <input name="newValue" value="<%= tagValue %>">
            <% } %>
          </div>

          <button>update</button>
        </form>
      </td>
    <% } %>

    <!-- START EDITING EXISTING VALUE -->

    <td>
      <% if (attr === 'tags' && canEditTag) { %>
        <span
          item="<%= attr %>"
          class="clickable-link link-start"
          onclick="startEdit('<%= attr + '-' + i %>')"
        >edit value</span>
      <% } %>
    </td>

    <!-- REORDER UP -->

    <td>
      <% if (i > 0) { %>
        <form action="<%= reorderItemPath %>" method="POST">
          <button type="submit" class="button-reorder">reorder up</button>
        </form>
      <% } %>
    </td>

    <td>
      <!-- DELETE ROW -->

      <form
        method="post"
        action="<%= deleteItemPath %>"
        onsubmit="return confirmDeletion('<%= attr %>')"
      >
        <button type="submit" class="button-delete">delete</button>
      </form>

      <!-- CANCEL EDITING EXISTING VALUE -->

      <span
        item="<%= attr + '-' + i %>"
        class="clickable-link link-cancel"
        onclick="cancelEdit()"
      >cancel</span>
    </td>
  </tr>
<% }); %>

<!-- ADD ANOTHER -->

<tr>
  <td>
    <% if (values.length == 0) { %>
      <b><%= attr %></b>
    <% } %>
  </td>

  <form action="<%= addItemPath %>" method="POST">
    <td colspan="2">
      <!-- START ADDING -->

      <a class="link-start" onclick="startEdit('<%= attr %>')">add</a>
      &#160;

      <!-- NEW VALUE -->

      <% if (dataType == 'people') { %>
        <div item="<%= attr %>" class="value-new">
          <%- include('../person/_dropdown', {
            fieldName: attr,
            selectedPerson: null,
            people: peopleDropdownList,
          }) %>
        </div>
      <% } else if (dataType === 'tags') { %>
        <div item="<%= attr %>" class="value-new">
          <%- include('../tag/_attach') %>
        </div>
      <% } else if (dataType == 'stories') { %>
        <div item="<%= attr %>" class="value-new">
          <%- include('../story/_dropdown', {
            fieldName: 'stories',
          }) %>
        </div>
      <% } else { %>
        <input item="<%= attr %>" class="value-new" type="text" value="" name="<%= attr %>">
      <% } %>
    </td>

    <!-- SUBMIT NEW ITEM -->
    <td>
      <button item="<%= attr %>" class="button-submit" type="submit">save</button>
      &#160;
    </td>
  </form>

  <td>
  </td>

  <!-- CANCEL NEW ITEM -->
  <td>
    <a item="<%= attr %>" class="link-cancel" onclick="cancelEdit()">cancel</a>
    &#160;
  </td>
</tr>
